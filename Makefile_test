#=======================================================================================
# Project folders
#=======================================================================================

#Main folders
SRCFOLDER := src/
INCFOLDER := inc/
BINFOLDER := bin/
LIBFOLDER := lib/
OBJFOLDER := obj/
TESTFOLDER := test/
OTHERFOLDER := other/

#Sub directory src
VIEWFOLDER  := $(SRCFOLDER)view
MODELFOLDER := $(SRCFOLDER)model
CNTLFOLDER  := $(SRCFOLDER)controller
UTILFOLDER  := $(SRCFOLDER)util
DAOFOLDER  := $(SRCFOLDER)dao

#Sub directory inc
VIEWINCFOLDER  := $(INCFOLDER)view
MODELINCFOLDER := $(INCFOLDER)model
CNTLINCFOLDER  := $(INCFOLDER)controller
UTILFOLDER := $(INCFOLDER)util
DAOFOLDER  := $(SRCFOLDER)dao

#Sub directory bin
TESTBINFOLDER := $(BINFOLDER)test/
APPBINFOLDER :=  $(BINFOLDER)app/
#======================================================================================
# Project flags
#======================================================================================
GPP = g++ $(ALLWARNINGS)
ALLWARNINGS := -Wall -Wextra -pedantic -Wshadow -Wredundant-decls -Woverloaded-virtual -Wsynth
IFLAG = -I./$(INCFOLDER)model -I./$(INCFOLDER)view -I./$(INCFOLDER)control -I./$(INCFOLDER)util -I./$(INCFOLDER)dao
GOOGLETESTFLAG = -lgtest -lgtest_main

#======================================================================================
# Project Strings
#======================================================================================
TESTSEPARATOR = "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
CLEANSEPARATOR = "- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - "
#======================================================================================
# Project files
#======================================================================================
MODELCPPFILES = $(wildcard src/model/*cpp)
VIEWCPPFILES = $(wildcard src/view/*cpp)
CNTLCPPFILES = $(wildcard src/controller/*cpp)
UTILCPPFILES = $(wildcard src/util/*cpp)
DAOCPPFILES = $(wildcard src/dao/*cpp)
MODELTESTCPPFILES = $(wildcard test/model/*cpp)
VIEWTESTCPPFILES = $(wildcard test/view/*cpp)
CNTLTESTCPPFILES = $(wildcard test/controller/*cpp)
UTILTESTCPPFILES = $(wildcard test/util/*cpp)
DAOTESTCPPFILES = $(wildcard test/dao/*cpp)

all: prepare automa

automa: modelObjects viewObjects controllerObjects daoObjects utilObjects
	$(GPP) obj/*.o src/main.cpp -o bin/app/$@ $(IFLAG)

#=====================================================================================
# Preparing object files
#=====================================================================================
# Model
modelObjects: $(MODELCPPFILES:src/model/%.cpp=obj/%.o)

obj/%.o: src/model/%.cpp
	$(GPP) -c $< -o $@ $(IFLAG)

# Controller
controllerObjects: $(CNTLCPPFILES:src/controller/%.cpp=obj/%.o)

obj/%.o: src/controller/%.cpp
	$(GPP) -c $< -o $@ $(IFLAG)

# View
viewObjects: $(VIEWCPPFILES:src/view/%.cpp=obj/%.o)

obj/%.o: src/view/%.cpp
	$(GPP) -c $< -o $@ $(IFLAG)

# Util
utilObjects: $(UTILCPPFILES:src/util/%.cpp=obj/%.o)

obj/%.o: src/util/%.cpp
	$(GPP) -c $< -o $@ $(IFLAG)

# DAO
daoObjects: $(DAOCPPFILES:src/dao/%.cpp=obj/%.o)
	
obj/%.o: src/dao/%.cpp
	$(GPP) -c $< -o $@ $(IFLAG)

#======================================================================================
# Testing
# About: The command test compile all tests and put it in the folder bin/test.
# 	You should have a file in the src folder mapped into test. To make it 
#		organized, you should keep the same folder structure in test folder.
# Example:
#		make test  -> Compile all the tests
#		make testModel -> Compile all the tests in model folder.
#======================================================================================
test: testModel testView testController testUtil testDao

# Test Model
testModel: $(MODELTESTCPPFILES:test/model/%Test.cpp=bin/test/%)

bin/test/%: test/model/%Test.cpp src/model/%.cpp
	$(GPP) $^ -o $@ $(IFLAG) $(GOOGLETESTFLAG)

#Test View
testView: $(VIEWTESTCPPFILES:test/view/%Test.cpp=bin/test/%)

bin/test/%: test/view/%Test.cpp src/view/%.cpp
	$(GPP) $^ -o $@ $(IFLAG) $(GOOGLETESTFLAG)

#Test Controller
testController: $(MODELTESTCPPFILES:test/controller/%Test.cpp=bin/test/%)

bin/test/%: test/controller/%Test.cpp src/controller/%.cpp
	$(GPP) $^ -o $@ $(IFLAG) $(GOOGLETESTFLAG)

#Test Util
testUtil: $(UTILTESTCPPFILES:test/util/%Test.cpp=bin/test/%)

bin/test/%: test/util/%Test.cpp src/util/%.cpp
	$(GPP) $^ -o $@ $(IFLAG) $(GOOGLETESTFLAG)

#Test Dao
testDao: $(DAOTESTCPPFILES:test/dao/%Test.cpp=bin/test/%)

bin/test/%: $(TESTFOLDER)dao/%Test.cpp src/dao/*.cpp
	@echo $(TESTSEPARATOR)
	@echo "++++++++ GOOGLE TEST: "  $@
	@echo $(TESTSEPARATOR)
	$(GPP) $^ -o $@ $(IFLAG) $(GOOGLETESTFLAG)

#=====================================================================================
# Project Actions
#=====================================================================================
PHONY: clean prepare doxy runTest

doxy:
	doxygen Doxyfile 

run:
	$(APPBINFOLDER)automa

runTest:
	$(TESTBINFOLDER)Filter

prepare:
	mkdir -p $(TESTFOLDER)controller
	mkdir -p $(TESTFOLDER)model
	mkdir -p $(TESTFOLDER)util
	mkdir -p $(TESTFOLDER)view
	mkdir -p $(TESTFOLDER)dao
	mkdir -p $(BINFOLDER)test
	mkdir -p $(BINFOLDER)app

clean:
	@echo $(CLEANSEPARATOR)
	rm -f $(OBJFOLDER)*
	rm -fr $(TESTBINFOLDER)*
	rm -fr $(APPBINFOLDER)*
	rm -fr $(OTHERFOLDER)Doxy/*

