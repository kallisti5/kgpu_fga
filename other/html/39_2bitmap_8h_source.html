<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>KGPU: services/raid6/raid456/39/bitmap.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">KGPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('39_2bitmap_8h_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">bitmap.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="39_2bitmap_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * bitmap.h: Copyright (C) Peter T. Breuer (ptb@ot.uc3m.es) 2003</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * additions: Copyright (C) 2003-2004, Paul Clements, SteelEye Technology, Inc.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#ifndef BITMAP_H</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define BITMAP_H 1</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00009"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a8967691cdddafecdb6b452e90bbf4b2b">    9</a></span>&#160;<span class="preprocessor">#define BITMAP_MAJOR_LO 3</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor"></span><span class="comment">/* version 4 insists the bitmap is in little-endian order</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * with version 3, it is host-endian which is non-portable</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00013"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a400f6fd48638ec6f448d400cdd2f93f6">   13</a></span>&#160;<span class="preprocessor">#define BITMAP_MAJOR_HI 4</span></div>
<div class="line"><a name="l00014"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a8add4afb8a31ad97e2825c02d5a74362">   14</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define BITMAP_MAJOR_HOSTENDIAN 3</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00016"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a6b67867cefcc5bc7d9678f9cb1abd9f0">   16</a></span>&#160;<span class="preprocessor">#define BITMAP_MINOR 39</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * in-memory bitmap:</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * Use 16 bit block counters to track pending writes to each &quot;chunk&quot;.</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * The 2 high order bits are special-purpose, the first is a flag indicating</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * whether a resync is needed.  The second is a flag indicating whether a</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * resync is active.</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * This means that the counter is actually 14 bits:</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * +--------+--------+------------------------------------------------+</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * | resync | resync |               counter                          |</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * | needed | active |                                                |</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * |  (0-1) |  (0-1) |              (0-16383)                         |</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> * +--------+--------+------------------------------------------------+</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> * The &quot;resync needed&quot; bit is set when:</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *    a &#39;1&#39; bit is read from storage at startup.</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> *    a write request fails on some drives</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> *    a resync is aborted on a chunk with &#39;resync active&#39; set</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> * It is cleared (and resync-active set) when a resync starts across all drives</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> * of the chunk.</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> * The &quot;resync active&quot; bit is set when:</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> *    a resync is started on all drives, and resync_needed is set.</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"> *       resync_needed will be cleared (as long as resync_active wasn&#39;t already set).</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"> * It is cleared when a resync completes.</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"> * The counter counts pending write requests, plus the on-disk bit.</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> * When the counter is &#39;1&#39; and the resync bits are clear, the on-disk</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"> * bit can be cleared as well, thus setting the counter to 0.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"> * When we set a bit, or in the counter (to start a write), if the fields is</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"> * 0, we first set the disk bit and set the counter to 1.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"> * If the counter is 0, the on-disk bit is clear and the stipe is clean</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> * Anything that dirties the stipe pushes the counter to 2 (at least)</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"> * and sets the on-disk bit (lazily).</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"> * If a periodic sweep find the counter at 2, it is decremented to 1.</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"> * If the sweep find the counter at 1, the on-disk bit is cleared and the</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"> * counter goes to zero.</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment"> * Also, we&#39;ll hijack the &quot;map&quot; pointer itself and use it as two 16 bit block</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"> * counters as a fallback when &quot;page&quot; memory cannot be allocated:</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"> * Normal case (page memory allocated):</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"> *     page pointer (32-bit)</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"> *     [ ] ------+</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment"> *               |</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"> *               +-------&gt; [   ][   ]..[   ] (4096 byte page == 2048 counters)</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"> *                          c1   c2    c2048</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"> * Hijacked case (page memory allocation failed):</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment"> *     hijacked page pointer (32-bit)</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment"> *     [          ][          ] (no page memory allocated)</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"> *      counter #1 (16-bit) counter #2 (16-bit)</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="preprocessor">#ifdef __KERNEL__</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="preprocessor">#define PAGE_BITS (PAGE_SIZE &lt;&lt; 3)</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define PAGE_BIT_SHIFT (PAGE_SHIFT + 3)</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keyword">typedef</span> __u16 bitmap_counter_t;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#define COUNTER_BITS 16</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define COUNTER_BIT_SHIFT 4</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define COUNTER_BYTE_RATIO (COUNTER_BITS / 8)</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define COUNTER_BYTE_SHIFT (COUNTER_BIT_SHIFT - 3)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#define NEEDED_MASK ((bitmap_counter_t) (1 &lt;&lt; (COUNTER_BITS - 1)))</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define RESYNC_MASK ((bitmap_counter_t) (1 &lt;&lt; (COUNTER_BITS - 2)))</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define COUNTER_MAX ((bitmap_counter_t) RESYNC_MASK - 1)</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define NEEDED(x) (((bitmap_counter_t) x) &amp; NEEDED_MASK)</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define RESYNC(x) (((bitmap_counter_t) x) &amp; RESYNC_MASK)</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define COUNTER(x) (((bitmap_counter_t) x) &amp; COUNTER_MAX)</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">/* how many counters per page? */</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor">#define PAGE_COUNTER_RATIO (PAGE_BITS / COUNTER_BITS)</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor"></span><span class="comment">/* same, except a shift value for more efficient bitops */</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#define PAGE_COUNTER_SHIFT (PAGE_BIT_SHIFT - COUNTER_BIT_SHIFT)</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor"></span><span class="comment">/* same, except a mask value for more efficient bitops */</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor">#define PAGE_COUNTER_MASK  (PAGE_COUNTER_RATIO - 1)</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#define BITMAP_BLOCK_SIZE 512</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define BITMAP_BLOCK_SHIFT 9</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">/* how many blocks per chunk? (this is variable) */</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#define CHUNK_BLOCK_RATIO(bitmap) ((bitmap)-&gt;mddev-&gt;bitmap_info.chunksize &gt;&gt; BITMAP_BLOCK_SHIFT)</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHUNK_BLOCK_SHIFT(bitmap) ((bitmap)-&gt;chunkshift - BITMAP_BLOCK_SHIFT)</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CHUNK_BLOCK_MASK(bitmap) (CHUNK_BLOCK_RATIO(bitmap) - 1)</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">/* when hijacked, the counters and bits represent even larger &quot;chunks&quot; */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">/* there will be 1024 chunks represented by each counter in the page pointers */</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor">#define PAGEPTR_BLOCK_RATIO(bitmap) \</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">            (CHUNK_BLOCK_RATIO(bitmap) &lt;&lt; PAGE_COUNTER_SHIFT &gt;&gt; 1)</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define PAGEPTR_BLOCK_SHIFT(bitmap) \</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor">            (CHUNK_BLOCK_SHIFT(bitmap) + PAGE_COUNTER_SHIFT - 1)</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define PAGEPTR_BLOCK_MASK(bitmap) (PAGEPTR_BLOCK_RATIO(bitmap) - 1)</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment"> * bitmap structures:</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a559125fc74fd9cd0de4de3b87de114e4">  127</a></span>&#160;<span class="preprocessor">#define BITMAP_MAGIC 0x6d746962</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">/* use these for bitmap-&gt;flags and bitmap-&gt;sb-&gt;state bit-fields */</span></div>
<div class="line"><a name="l00130"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213a">  130</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213a">bitmap_state</a> {</div>
<div class="line"><a name="l00131"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa96d4564715ed98cf5e7984c740798761">  131</a></span>&#160;    <a class="code" href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa96d4564715ed98cf5e7984c740798761">BITMAP_STALE</a>  = 0x002,  <span class="comment">/* the bitmap file is out of date or had -EIO */</span></div>
<div class="line"><a name="l00132"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aae1758502dde8c12045df9e7dd2a6062e">  132</a></span>&#160;    <a class="code" href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aae1758502dde8c12045df9e7dd2a6062e">BITMAP_WRITE_ERROR</a> = 0x004, <span class="comment">/* A write error has occurred */</span></div>
<div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="39_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa030809d79c4fcc426d8a20113b5ac0e6">  133</a></span>&#160;    <a class="code" href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa030809d79c4fcc426d8a20113b5ac0e6">BITMAP_HOSTENDIAN</a> = 0x8000,</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;};</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">/* the superblock at the front of the bitmap file -- little endian */</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structbitmap__super__s.html">bitmap_super_s</a> {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#aeeb6615388a0b3d040f507397280bd14">magic</a>;        <span class="comment">/*  0  BITMAP_MAGIC */</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#aab8329508b2531dcaafc944ff018e2ca">version</a>;      <span class="comment">/*  4  the bitmap major for now, could change... */</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    __u8  <a class="code" href="structbitmap__super__s.html#a1ac5bd52375c7bd7daa870e7845cf123">uuid</a>[16];      <span class="comment">/*  8  128 bit uuid - must match md device uuid */</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    __le64 <a class="code" href="structbitmap__super__s.html#a0d1d15f26c89833efb6229dc4a633c4e">events</a>;       <span class="comment">/* 24  event counter for the bitmap (1)*/</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    __le64 <a class="code" href="structbitmap__super__s.html#a2c95c6a338aad647e1bfbbf037592852">events_cleared</a>;<span class="comment">/*32  event counter when last bit cleared (2) */</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    __le64 <a class="code" href="structbitmap__super__s.html#af09ae8502ab2dbc94b1c78f16c05779f">sync_size</a>;    <span class="comment">/* 40  the size of the md device&#39;s sync range(3) */</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#aeab2ac27c460b2c343a616acb7f9500d">state</a>;        <span class="comment">/* 48  bitmap state information */</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#a7ff54d9b37ee4edb774f7a360f44e50d">chunksize</a>;    <span class="comment">/* 52  the bitmap chunk size in bytes */</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#a1427396719517d2dde1893be834552c7">daemon_sleep</a>; <span class="comment">/* 56  seconds between disk flushes */</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    __le32 <a class="code" href="structbitmap__super__s.html#a92ea308641abcd28133376ad115659ea">write_behind</a>; <span class="comment">/* 60  number of outstanding write-behind writes */</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    __u8  <a class="code" href="structbitmap__super__s.html#a2adfbdf3c021d896ce660018a5bcc0a3">pad</a>[256 - 64]; <span class="comment">/* set to zero */</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;} <a class="code" href="38_2bitmap_8h.html#a892e1ebab4432ef16c8e08a84c722db1">bitmap_super_t</a>;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">/* notes:</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"> * (1) This event counter is updated before the eventcounter in the md superblock</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"> *    When a bitmap is loaded, it is only accepted if this event counter is equal</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> *    to, or one greater than, the event counter in the superblock.</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> * (2) This event counter is updated when the other one is *if*and*only*if* the</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> *    array is not degraded.  As bits are not cleared when the array is degraded,</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"> *    this represents the last time that any bits were cleared.</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"> *    If a device is being added that has an event count with this value or</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment"> *    higher, it is accepted as conforming to the bitmap.</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment"> * (3)This is the number of sectors represented by the bitmap, and is the range that</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment"> *    resync happens across.  For raid1 and raid5/6 it is the size of individual</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment"> *    devices.  For raid10 it is the size of the array.</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="preprocessor">#ifdef __KERNEL__</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">/* the in-memory bitmap is represented by bitmap_pages */</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keyword">struct </span>bitmap_page {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">     * map points to the actual memory page</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordtype">char</span> *map;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">     * in emergencies (when map cannot be alloced), hijack the map</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">     * pointer and use it as two counters itself</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hijacked:1;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">     * count of dirty bits on the page</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  count:31;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;};</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">/* keep track of bitmap file pages that have pending writes on them */</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keyword">struct </span>page_list {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> list;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keyword">struct </span>page *page;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;};</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">/* the main bitmap structure - one per mddev */</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keyword">struct </span>bitmap {</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keyword">struct </span>bitmap_page *bp;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pages; <span class="comment">/* total number of pages in the bitmap */</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> missing_pages; <span class="comment">/* number of pages not yet allocated */</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <a class="code" href="structmddev__s.html">mddev_t</a> *mddev; <span class="comment">/* the md device that the bitmap is for */</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordtype">int</span> counter_bits; <span class="comment">/* how many bits per block counter */</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">/* bitmap chunksize -- how much data does each bit represent? */</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> chunkshift; <span class="comment">/* chunksize = 2^chunkshift (for bitops) */</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> chunks; <span class="comment">/* total number of data chunks for the array */</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="comment">/* We hold a count on the chunk currently being synced, and drop</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">     * it when the last block is started.  If the resync is aborted</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">     * midway, we need to be able to drop that count, so we remember</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">     * the counted chunk..</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> syncchunk;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    __u64   events_cleared;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordtype">int</span> need_sync;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">/* bitmap spinlock */</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    spinlock_t lock;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keyword">struct </span>file *file; <span class="comment">/* backing disk file */</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keyword">struct </span>page *sb_page; <span class="comment">/* cached copy of the bitmap file superblock */</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keyword">struct </span>page **filemap; <span class="comment">/* list of cache pages for the file */</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *filemap_attr; <span class="comment">/* attributes associated w/ filemap pages */</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> file_pages; <span class="comment">/* number of pages in the file */</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordtype">int</span> last_page_size; <span class="comment">/* bytes in the last page */</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> logattrs; <span class="comment">/* used when filemap_attr doesn&#39;t exist</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">                 * because we are working with a dirty_log</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="dm-crypt_8c.html#ab6b306ef981f5e21bb41ea2c2dbe8cd9">flags</a>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordtype">int</span> allclean;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    atomic_t behind_writes;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> behind_writes_used; <span class="comment">/* highest actual value at runtime */</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">     * the bitmap daemon - periodically wakes up and sweeps the bitmap</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">     * file, cleaning up bits and flushing out pages to disk as necessary</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> daemon_lastrun; <span class="comment">/* jiffies of last run */</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> last_end_sync; <span class="comment">/* when we lasted called end_sync to</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">                      * update bitmap with resync progress */</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    atomic_t pending_writes; <span class="comment">/* pending writes to the bitmap file */</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    wait_queue_head_t write_wait;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    wait_queue_head_t overflow_wait;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    wait_queue_head_t behind_wait;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keyword">struct </span>sysfs_dirent *sysfs_can_clear;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;};</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">/* the bitmap API */</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">/* these are used only by md/bitmap */</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keywordtype">int</span>  bitmap_create(<a class="code" href="structmddev__s.html">mddev_t</a> *mddev);</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keywordtype">int</span> bitmap_load(<a class="code" href="structmddev__s.html">mddev_t</a> *mddev);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keywordtype">void</span> bitmap_flush(<a class="code" href="structmddev__s.html">mddev_t</a> *mddev);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="keywordtype">void</span> bitmap_destroy(<a class="code" href="structmddev__s.html">mddev_t</a> *mddev);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keywordtype">void</span> bitmap_print_sb(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="keywordtype">void</span> bitmap_update_sb(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="keywordtype">int</span>  bitmap_setallbits(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="keywordtype">void</span> bitmap_write_all(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keywordtype">void</span> bitmap_dirty_bits(<span class="keyword">struct</span> bitmap *bitmap, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> s, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> e);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">/* these are exported */</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keywordtype">int</span> bitmap_startwrite(<span class="keyword">struct</span> bitmap *bitmap, sector_t offset,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sectors, <span class="keywordtype">int</span> behind);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="keywordtype">void</span> bitmap_endwrite(<span class="keyword">struct</span> bitmap *bitmap, sector_t offset,</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sectors, <span class="keywordtype">int</span> success, <span class="keywordtype">int</span> behind);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="keywordtype">int</span> bitmap_start_sync(<span class="keyword">struct</span> bitmap *bitmap, sector_t offset, sector_t *blocks, <span class="keywordtype">int</span> degraded);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordtype">void</span> bitmap_end_sync(<span class="keyword">struct</span> bitmap *bitmap, sector_t offset, sector_t *blocks, <span class="keywordtype">int</span> aborted);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keywordtype">void</span> bitmap_close_sync(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="keywordtype">void</span> bitmap_cond_end_sync(<span class="keyword">struct</span> bitmap *bitmap, sector_t sector);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="keywordtype">void</span> bitmap_unplug(<span class="keyword">struct</span> bitmap *bitmap);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="keywordtype">void</span> bitmap_daemon_work(<a class="code" href="structmddev__s.html">mddev_t</a> *mddev);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="ttc" id="structbitmap__super__s_html"><div class="ttname"><a href="structbitmap__super__s.html">bitmap_super_s</a></div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00137">bitmap.h:137</a></div></div>
<div class="ttc" id="38_2bitmap_8h_html_a892e1ebab4432ef16c8e08a84c722db1"><div class="ttname"><a href="38_2bitmap_8h.html#a892e1ebab4432ef16c8e08a84c722db1">bitmap_super_t</a></div><div class="ttdeci">struct bitmap_super_s bitmap_super_t</div></div>
<div class="ttc" id="38_2bitmap_8h_html_a52f1114ebcd13f3ccdbbac0dcae9213a"><div class="ttname"><a href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213a">bitmap_state</a></div><div class="ttdeci">bitmap_state</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00130">bitmap.h:130</a></div></div>
<div class="ttc" id="dm-crypt_8c_html_ab6b306ef981f5e21bb41ea2c2dbe8cd9"><div class="ttname"><a href="dm-crypt_8c.html#ab6b306ef981f5e21bb41ea2c2dbe8cd9">flags</a></div><div class="ttdeci">flags</div><div class="ttdef"><b>Definition:</b> <a href="dm-crypt_8c_source.html#l00111">dm-crypt.c:111</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_aeab2ac27c460b2c343a616acb7f9500d"><div class="ttname"><a href="structbitmap__super__s.html#aeab2ac27c460b2c343a616acb7f9500d">bitmap_super_s::state</a></div><div class="ttdeci">__le32 state</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00144">bitmap.h:144</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a0d1d15f26c89833efb6229dc4a633c4e"><div class="ttname"><a href="structbitmap__super__s.html#a0d1d15f26c89833efb6229dc4a633c4e">bitmap_super_s::events</a></div><div class="ttdeci">__le64 events</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00141">bitmap.h:141</a></div></div>
<div class="ttc" id="38_2bitmap_8h_html_a52f1114ebcd13f3ccdbbac0dcae9213aa030809d79c4fcc426d8a20113b5ac0e6"><div class="ttname"><a href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa030809d79c4fcc426d8a20113b5ac0e6">BITMAP_HOSTENDIAN</a></div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00133">bitmap.h:133</a></div></div>
<div class="ttc" id="structlist__head_html"><div class="ttname"><a href="structlist__head.html">list_head</a></div><div class="ttdef"><b>Definition:</b> <a href="list_8h_source.html#l00013">list.h:13</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a2c95c6a338aad647e1bfbbf037592852"><div class="ttname"><a href="structbitmap__super__s.html#a2c95c6a338aad647e1bfbbf037592852">bitmap_super_s::events_cleared</a></div><div class="ttdeci">__le64 events_cleared</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00142">bitmap.h:142</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a7ff54d9b37ee4edb774f7a360f44e50d"><div class="ttname"><a href="structbitmap__super__s.html#a7ff54d9b37ee4edb774f7a360f44e50d">bitmap_super_s::chunksize</a></div><div class="ttdeci">__le32 chunksize</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00145">bitmap.h:145</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_af09ae8502ab2dbc94b1c78f16c05779f"><div class="ttname"><a href="structbitmap__super__s.html#af09ae8502ab2dbc94b1c78f16c05779f">bitmap_super_s::sync_size</a></div><div class="ttdeci">__le64 sync_size</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00143">bitmap.h:143</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a92ea308641abcd28133376ad115659ea"><div class="ttname"><a href="structbitmap__super__s.html#a92ea308641abcd28133376ad115659ea">bitmap_super_s::write_behind</a></div><div class="ttdeci">__le32 write_behind</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00147">bitmap.h:147</a></div></div>
<div class="ttc" id="38_2bitmap_8h_html_a52f1114ebcd13f3ccdbbac0dcae9213aa96d4564715ed98cf5e7984c740798761"><div class="ttname"><a href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aa96d4564715ed98cf5e7984c740798761">BITMAP_STALE</a></div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00131">bitmap.h:131</a></div></div>
<div class="ttc" id="38_2bitmap_8h_html_a52f1114ebcd13f3ccdbbac0dcae9213aae1758502dde8c12045df9e7dd2a6062e"><div class="ttname"><a href="38_2bitmap_8h.html#a52f1114ebcd13f3ccdbbac0dcae9213aae1758502dde8c12045df9e7dd2a6062e">BITMAP_WRITE_ERROR</a></div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00132">bitmap.h:132</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_aab8329508b2531dcaafc944ff018e2ca"><div class="ttname"><a href="structbitmap__super__s.html#aab8329508b2531dcaafc944ff018e2ca">bitmap_super_s::version</a></div><div class="ttdeci">__le32 version</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00139">bitmap.h:139</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a1427396719517d2dde1893be834552c7"><div class="ttname"><a href="structbitmap__super__s.html#a1427396719517d2dde1893be834552c7">bitmap_super_s::daemon_sleep</a></div><div class="ttdeci">__le32 daemon_sleep</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00146">bitmap.h:146</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a1ac5bd52375c7bd7daa870e7845cf123"><div class="ttname"><a href="structbitmap__super__s.html#a1ac5bd52375c7bd7daa870e7845cf123">bitmap_super_s::uuid</a></div><div class="ttdeci">__u8 uuid[16]</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00140">bitmap.h:140</a></div></div>
<div class="ttc" id="structmddev__s_html"><div class="ttname"><a href="structmddev__s.html">mddev_s</a></div><div class="ttdef"><b>Definition:</b> <a href="38_2md_8h_source.html#l00136">md.h:136</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_a2adfbdf3c021d896ce660018a5bcc0a3"><div class="ttname"><a href="structbitmap__super__s.html#a2adfbdf3c021d896ce660018a5bcc0a3">bitmap_super_s::pad</a></div><div class="ttdeci">__u8 pad[256-64]</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00149">bitmap.h:149</a></div></div>
<div class="ttc" id="structbitmap__super__s_html_aeeb6615388a0b3d040f507397280bd14"><div class="ttname"><a href="structbitmap__super__s.html#aeeb6615388a0b3d040f507397280bd14">bitmap_super_s::magic</a></div><div class="ttdeci">__le32 magic</div><div class="ttdef"><b>Definition:</b> <a href="38_2bitmap_8h_source.html#l00138">bitmap.h:138</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_e21752eb5e4b36c827bff61d317f78b6.html">services</a></li><li class="navelem"><a class="el" href="dir_ca8269871e9246b5596af65eccc5b448.html">raid6</a></li><li class="navelem"><a class="el" href="dir_c4d83e922204ca964da2b2dfbf65f701.html">raid456</a></li><li class="navelem"><a class="el" href="dir_609f1436e6120bf64c881f153df84e3a.html">39</a></li><li class="navelem"><a class="el" href="39_2bitmap_8h.html">bitmap.h</a></li>
    <li class="footer">Generated on Sun Dec 7 2014 14:58:23 for KGPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
